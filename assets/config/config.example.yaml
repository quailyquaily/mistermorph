# Example config for mistermorph
#
# Usage:
#   ./mistermorph run --config ./assets/config/config.example.yaml --task "..."
#
# Env vars (override config):
#   - Preferred: MISTER_MORPH_LLM_PROVIDER, MISTER_MORPH_LLM_ENDPOINT, MISTER_MORPH_LLM_MODEL, MISTER_MORPH_LLM_API_KEY

# Global User-Agent for outbound HTTP requests (tools like url_fetch, web_search, etc).
user_agent: "mistermorph/1.0 (+https://github.com/quailyquaily)"

llm:
  # LLM provider name. Supported: openai|openai_custom|deepseek|xai|gemini|azure|anthropic|bedrock|susanoo.
  provider: openai
  # Default model used by both the main agent loop and (by default) smart skills selection.
  model: "gpt-5.2"
  # Base URL for providers that use OpenAI-compatible endpoints.
  endpoint: "https://api.openai.com"
  # Provider API key. Prefer env var to avoid committing secrets.
  api_key: "" # or set via MISTER_MORPH_LLM_API_KEY
  # Per-LLM HTTP request timeout (0 uses provider default).
  request_timeout: "90s"
  # Tool-call emulation mode for providers/models without native tool calling.
  # Values: off | fallback | force
  tools_emulation_mode: "off"
  # Provider-specific settings for Azure OpenAI.
  azure:
    api_key: ""
    endpoint: ""
    deployment: "" # Azure OpenAI deployment name
  # Provider-specific settings for AWS Bedrock.
  bedrock:
    aws_key: ""
    aws_secret: ""
    region: ""
    model_arn: ""

logging:
  # debug|info|warn|error
  # - info: emits high-level progress (run_start, tool_call, tool_done, final)
  # - debug: also logs thoughts and extra details
  level: "info"
  # text|json
  format: "text"
  # Include source file:line in each log record.
  add_source: false
  # If true, logs the model's "thought" fields (may contain sensitive info).
  include_thoughts: false
  # If true, logs tool_call parameters (redacted and truncated).
  include_tool_params: false
  # Even if include_tool_params=false, logs a small per-tool args summary (for example url_fetch.url, web_search.q, contacts_send.contact_id).
  # For bash, the full command is only logged when include_tool_params=true.
  # If true, logs loaded SKILL.md contents (truncated).
  include_skill_contents: false
  # Limits for logged content.
  max_thought_chars: 2000
  max_json_bytes: 32768
  max_string_value_chars: 2000
  max_skill_content_chars: 8000
  # Extra parameter keys to redact in logs (in addition to built-in defaults like token/api_key/password).
  redact_keys: []

# Secrets / auth profiles
#
# Goal: allow safe credential injection without ever putting secrets into:
# - SKILL.md
# - tool params / logs
# - LLM context
#
# When `secrets.enabled: true`, `bash` can still be enabled, but `curl` is rejected by default
# to avoid "bash + curl" carrying authenticated HTTP requests (use `url_fetch` + `auth_profile` instead).
secrets:
  # Disabled by default (fail-closed).
  enabled: false
  # Allowlisted profile ids. Default empty means no profiles can be used.
  allow_profiles: []
  # If true, tools using `auth_profile` require the profile id to be declared by at least one loaded skill
  # in its SKILL.md frontmatter: `auth_profiles: ["..."]`.
  require_skill_profiles: false
  # Optional alias mapping: secret_ref -> ENV_VAR_NAME
  aliases: {}

# Auth profiles are referenced by tools via `auth_profile: "<id>"`.
#
# NOTE: This is a sample. Do NOT store secret values here. Use environment variables.
auth_profiles:
  # jsonbill:
  #   credential:
  #     kind: api_key
  #     secret_ref: JSONBILL_API_KEY
  #   allow:
  #     url_prefixes: ["https://api.jsonbill.com/tasks/docs"]
  #     methods: ["POST"]
  #     follow_redirects: false
  #     allow_proxy: false
  #     deny_private_ips: true
  #   bindings:
  #     url_fetch:
  #       inject:
  #         location: header
  #         name: Authorization
  #         format: bearer
  #       allow_user_headers: true
  #       user_header_allowlist: ["Accept", "Content-Type", "User-Agent"]

# Guard (M1)
#
# Guard is a lightweight, content/workflow safety layer:
# - outbound destination allowlists (primarily url_fetch)
# - redaction for tool outputs + final outputs
# - async approvals + audit trail (JSONL), with approvals state in file storage
guard:
  enabled: true
  # Directory name under file_state_dir for guard state.
  dir_name: "guard"
  network:
    url_fetch:
      # Allow outbound HTTP only to these URL prefixes (fail-closed when empty).
      allowed_url_prefixes: ["https://"]
      # Deny localhost and literal private IP destinations.
      deny_private_ips: true
      # Redirects are a common allowlist bypass; keep disabled by default.
      follow_redirects: false
      # Ignore HTTP(S)_PROXY by default to avoid unexpected routing/MITM.
      allow_proxy: false
  redaction:
    enabled: true
    # Optional additional regex patterns (built-in redactors always apply).
    patterns: [] # [{name: "...", re: "..."}]
  bash:
    # bash can bypass url_fetch policies; require approval by default when guard is enabled.
    require_approval: true
  audit:
    # JSONL audit log path (append-only). When empty, defaults to <file_state_dir>/<guard.dir_name>/audit/guard_audit.jsonl.
    jsonl_path: ""
    rotate_max_bytes: 104857600
  approvals:
    enabled: true

tools:
  read_file:
    # Enable the read_file tool (reads a local file).
    # Note: currently always enabled; this section configures limits/policy.
    max_bytes: 262144
    # Denylist for sensitive local files. Basenames match anywhere (e.g. "config.yaml" blocks "./x/config.yaml").
    deny_paths:
      - "config.yaml"
  write_file:
    # Enable the write_file tool (writes text to a local file).
    # Note: writes are restricted to `file_cache_dir` or `file_state_dir`.
    enabled: true
    # Max bytes allowed per write_file call.
    max_bytes: 524288
  memory:
    # Enable memory tools.
    enabled: true
    recently:
      # Max items returned by memory_recently.
      max_items: 50
  contacts:
    # Enable contacts tools (contacts_list / contacts_candidate_rank / contacts_send / contacts_feedback_update).
    enabled: true
  url_fetch:
    # Enable the url_fetch tool (HTTP(S) GET/POST/PUT/DELETE, truncated output).
    enabled: true
    # Per-request timeout.
    timeout: "30s"
    # Max response bytes to read (tool will truncate beyond this).
    max_bytes: 524288
    # Max response bytes to read when download_path is set.
    max_bytes_download: 104857600
  web_search:
    # Enable the web_search tool (DuckDuckGo HTML by default).
    enabled: true
    # DuckDuckGo HTML endpoint.
    base_url: "https://duckduckgo.com/html/"
    # Per-request timeout.
    timeout: "20s"
    # Default max results (tool also enforces a hard cap).
    max_results: 5
  # Dangerous: enables local shell execution.
  bash:
    # Enable the bash tool.
    # Note: when `secrets.enabled: true`, bash is allowed but `curl` is denied by default.
    enabled: true
    # If true, prompts on /dev/tty before each command execution.
    confirm: true
    # Default timeout for each bash command.
    timeout: "30s"
    # Max combined output bytes kept per stream (stdout/stderr) before truncation.
    max_output_bytes: 262144
    # Denylist for sensitive local files. If a command references one of these paths, the tool errors.
    # (Best-effort string match; not a full sandbox.)
    deny_paths:
      - "config.yaml"

# Markdown-based memory
memory:
  # Enable memory (Telegram + run).
  enabled: true
  # Directory name under file_state_dir for memory files.
  dir_name: "memory"
  # How many recent days of short-term memory to load on session start.
  short_term_days: 7
  injection:
    # If true, inject memory summaries into the system prompt.
    enabled: true
    max_items: 50

# MAEP (Mesh Agent Exchange Protocol) local state.
maep:
  listen_addrs: ["/ip4/0.0.0.0/tcp/4021"]

# Contacts business state (proactive sharing profiles/candidates/audit).
contacts:
  # Directory name under file_state_dir for contacts domain storage.
  dir_name: "contacts"
  proactive:
    # Max turns for one MAEP conversation session (peer_id + conversation_id).
    max_turns_per_session: 6
    # Cooldown after reaching max turns before auto-reply can resume.
    session_cooldown: "10m"
    # Cooldown applied when proactive/direct send fails (e.g. peer unavailable).
    failure_cooldown: "1h"
  # Human-contact behavior switches (channel-agnostic extension point).
  human:
    # If false, proactive pipeline ignores human contacts.
    enabled: true
    send:
      # If false, proactive --send never sends to human contacts.
      enabled: true
      # If false, proactive --send avoids public contexts (e.g. Telegram group/supergroup).
      public_enabled: true

# Intent inference (preflight)
intent:
  # If true, run a lightweight intent inference before the main task.
  enabled: true
  # Max history messages to include for intent inference.
  max_history: 8
  # Per-request timeout for intent inference.
  timeout: "8s"

skills:
  # Directory name under file_state_dir for skills.
  dir_name: "skills"
  # Note: the default scan also includes ~/.claude/skills and ~/.codex/skills.
  # off|explicit|smart
  # - off: never load skills
  # - explicit: only load skills from skills.load and/or $SkillName references (if skills.auto=true)
  # - smart: run a small "router" model call to decide which skills to load (recommended default)
  mode: smart
  # If true, also loads skills referenced as $SkillName in the task (useful in explicit mode).
  auto: true
  # Skills to always load (by skill name or id).
  load: [] # e.g. ["skill-creator", "my-skill-id"]
  # For smart mode: max number of skills to load.
  max_load: 3
  # For smart mode: bytes to preview per SKILL.md when building the selection catalog.
  preview_bytes: 2048
  # For smart mode: cap how many discovered skills to include in the selection catalog.
  catalog_limit: 200
  # For smart mode: timeout for the selection call.
  select_timeout: "10s"
  # Optional: use a different model for selecting skills (defaults to "model").
  selector_model: ""

# Daemon mode (local HTTP server).
server:
  # Bind address for `mistermorph serve`.
  bind: "127.0.0.1"
  # Port for `mistermorph serve`.
  port: 8787
  # Bearer token required for submit/get endpoints.
  # Prefer env var: MISTER_MORPH_SERVER_AUTH_TOKEN
  auth_token: ""
  # Max queued tasks (in-memory).
  max_queue: 100
  # Base URL used by `mistermorph submit` (client).
  url: "http://127.0.0.1:8787"
  # If true, `mistermorph serve` also starts an embedded MAEP listener.
  # Can be overridden by CLI flag --with-maep.
  with_maep: false

# Telegram bot mode (`mistermorph telegram`).
telegram:
  # Bot token from @BotFather. Prefer env var: MISTER_MORPH_TELEGRAM_BOT_TOKEN
  # If true, `mistermorph telegram` also starts an embedded MAEP listener.
  # Can be overridden by CLI flag --with-maep.
  with_maep: false
  bot_token: ""
  # Optional allowlist of chat ids (strings). If empty, allows all.
  allowed_chat_ids: []
  # Optional aliases (keywords). In groups, these may trigger a response depending on `group_trigger_mode`.
  # Note: if Bot Privacy Mode is enabled, the bot may not receive non-command messages.
  aliases: []
  # Group trigger mode:
  # - strict: only /ask, replies, and @mentions trigger in groups.
  # - smart: replies/@mentions trigger; aliases are LLM-validated for direct addressing.
  group_trigger_mode: "smart"
  # In smart mode, how far from the start (in runes) an alias can appear to count as "addressing".
  smart_addressing_max_chars: 24
  # Minimum confidence required to accept the LLM addressing classification.
  smart_addressing_confidence: 0.55
  # Long polling timeout.
  poll_timeout: "30s"
  # Per-message agent timeout (0 uses top-level timeout).
  task_timeout: "0s"
  # Max number of chats processed concurrently (each chat remains serial).
  max_concurrency: 3
  # Max chat history messages kept per chat.
  history_max_messages: 20
  # Emoji reactions (lightweight replies).
  reactions:
    enabled: true
  # Note: file handling is always enabled; files are downloaded under file_cache_dir/telegram/ (max size is hardcoded).

# Heartbeat (periodic awareness/checkpoint).
heartbeat:
  # Enable heartbeats by default.
  enabled: true
  # Interval between heartbeats (use "0m" to disable without changing enabled).
  interval: "30m"

# Agent loop limits.
# - max_steps: maximum tool-call steps in the ReAct loop.
max_steps: 15
# - parse_retries: how many times to ask the model to retry if it emits invalid JSON.
parse_retries: 2
# - max_token_budget: stop the loop once cumulative tokens exceed this (0 disables).
max_token_budget: 0
# Overall run timeout.
timeout: "10m"
# If true, prints extra debug info to stderr (tool steps, selected skills, etc).
trace: false
# Base directory for local state (memory/skills/heartbeat).
file_state_dir: "~/.morph"
# Global temporary file cache directory used for inbound/outbound file handling (e.g. Telegram).
file_cache_dir: "/var/cache/morph"
file_cache:
  # Note: cleanup runs on startup (best-effort).
  # Max age for cached files (0 disables age-based cleanup).
  max_age: "168h"
  # Max number of cached files (0 disables count-based cleanup).
  max_files: 1000
  # Max total bytes of cached files (0 disables size-based cleanup).
  max_total_bytes: 536870912
# Plan tool defaults.
plan:
  # Default max steps for plan_create (can be overridden by tool params).
  max_steps: 6
